---

import ContentPageLayout from "@/layouts/ContentPageLayout.astro";
import { getCollection, render} from 'astro:content';
import { formatDate } from '@/components/blog/blogUtils';
import AuthorCard from '@/components/blog/AuthorCard.astro';
import MDXComponents from '@/components/mdx/MDXComponents';
import "@/styles/breadcrumbs.css";
import { Image } from "astro:assets";

/**
 * Magic required function for dynamic routes; deteremines the slug
 */
export async function getStaticPaths() {
	const posts = await getCollection('blog');
	return posts.map((post) => ({
		params: { 
			slug: post.data.slug
		},
		props: post,
	}));
}

/**
 * Properties used on this page
 */
const post = Astro.props;
const title = post.data.title;
const description = post.data.description;
const imageFilename = post.data.image;
const postAuthorId = post.data.author;
const date = formatDate(post.data.date);
const { Content, headings, remarkPluginFrontmatter } = await render(post);

interface Author {
	id: string;
	name: string;
	'social-github': string;
	'social-linkedin' : string;
	'social-x' : string;
}

/**
 * Get Author Data
 */
const authors = await getCollection('authors');
const author = authors.find(author => author.id === postAuthorId);

const imageDir = '/src/assets/blog/';
const imagePath = imageDir + imageFilename;
console.log(imagePath);
const images = import.meta.glob<{ default: ImageMetadata }>('/src/assets/blog/*.{jpeg,jpg,png,gif}') // Must take a String literal otherwise we'd reuse imageDir here
if (!images[imagePath]) throw new Error(`"${imagePath}" does not exist`);

// Handle custom OG image for social media
const ogImageFilename = post.data.ogImage;
let ogImageUrl;
let ogImageMetadata;
if (ogImageFilename) {
  const ogImagePath = imageDir + ogImageFilename;
  if (images[ogImagePath]) {
    ogImageMetadata = await images[ogImagePath]();
    ogImageUrl = new URL(ogImageMetadata.default.src, Astro.site);
  }
}

---

<ContentPageLayout title={title} 
  description={description} 
  headings={headings} 
  maxWidth="wide"
	showTitleAsH1={false}
  ogImage={ogImageUrl}>

	<div class="flex flex-col lg:flex-row mt-8 mb-8 border rounded-md bg-muted overflow-hidden">
		
		<div class="flex-1">

			{/* Show full-width header if custom OG image is provided */}
			{ogImageMetadata && (
				<div class="w-full mb-8 -mt-8">
					<Image 
						src={ogImageMetadata.default}
						alt={post.data.title}
						class="w-full h-auto rounded-lg"
					/>
				</div>
			)}
      <div class="ml-6 lg:ml-6 ml-0 p-4 lg:p-6">
			{/* Only show sidebar image if no custom OG image */}
		  {post.data.image && !ogImageMetadata && (
			<h1 class="pb-0 mb-0 text-muted-background leading-tight">{title}</h1>
			)}
			<p class="italic mt-1 pb-0 text-sm">
				Published on <b>{date}</b>
			</p>
      <AuthorCard author={author}/>
			</div>
	  </div>
		{/* Only show sidebar image if no custom OG image */}
		{post.data.image && !ogImageMetadata && (
		<div class="flex-none order-last lg:order-none lg:max-w-xs lg:self-stretch">
			<Image 
				src={images[imagePath]()}
				alt={post.data.title}
				width={800}
				height={600}
				class="w-full h-full object-cover"
			/>
		</div>
		)}
	</div>
  <div class="mb-16">
	  <Content components={MDXComponents} />
	</div>
</ContentPageLayout>
