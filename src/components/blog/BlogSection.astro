---
import { formatDate } from '@/components/blog/blogUtils';
import { Image } from 'astro:assets';
import { getUrlRelativeToBase } from '@/lib/utils';
import { getCollection } from 'astro:content';

interface Props {
   imagePath: string;
   altText: string;
   name: string;
   age: number;
}

interface BlogPost {
  data: {
    title: string;
    author: string;
    date: string;
    excerpt: string;
    image?: string;
    ogImage?: string;
    tags?: string[];
    readTime?: string;
  }
}

interface Props {
  title?: string;
  tagline?: string;
  description?: string;
  posts: BlogPost[];
  layout?: 'grid' | 'list' | 'featured' | 'modern';
  showExcerpts?: boolean;
  showTags?: boolean;
  showAuthors?: boolean;
  showReadTime?: boolean;
  showCategories?: boolean;
  categories?: string[];
  activeCategory?: string;
  className?: string;
}

const { 
  title = "Short and clear engaging headline for a blog",
  tagline = "Latest insights",
  description = "Add a concise value statement that captures reader interest and previews content value. Focus on benefits while keeping it under two lines.",
  posts,
  layout = 'grid',
  showExcerpts = true,
  showTags = true,
  showAuthors = true,
  showReadTime = true,
  className = '',
} = Astro.props;

const sectionClasses = [
  'blog-section',
  `layout-${layout}`,
  className
].filter(Boolean).join(' ');

const imagePath = '/src/assets/blog/';
const images = import.meta.glob<{ default: ImageMetadata }>('/src/assets/blog/*.{jpeg,jpg,png,gif}') // Must take a String literal otherwise we'd reuse imageDir here

// Set the postURL only if the post exists in Content Collections and has an ID; else set it to NO-OP; this is used in examples docs
const getPostURL = (post) => post.data.slug != null ? getUrlRelativeToBase("blog/" + post.data.slug) : "javascript:void(null);";

// Get all authors to map author IDs to names
const authors = await getCollection('authors');
const getAuthorName = (authorId: string) => {
  const author = authors.find(a => a.id === authorId);
  return author?.data?.name || authorId;
};
---

<section class={`bg-grey-50 text-foreground ${sectionClasses}`}>
  <div class="container px-0 mx-0">

    <!-- Modern Layout Header -->
    {layout === 'modern' && (
      <div class="flex flex-col mb-24 mx-auto md:mb-18 pt-0 mt-0">
        <h1 class="mb-2 mt-4">{title}</h1>
        
        {description && (
          <p class="text-lg leading-relaxed text-muted-foreground m-0 md:text-base">{description}</p>
        )}
      </div>
    )}

    <!-- Blog Posts -->
    {posts.length > 0 && (
      <div class={`grid gap-8 ${
        layout === 'grid' ? 'grid-cols-1 md:grid-cols-2 lg:grid-cols-3 max-w-6xl mx-auto' :
        layout === 'modern' ? 'grid-cols-1 md:grid-cols-2 lg:grid-cols-3' :
        layout === 'list' ? 'grid-cols-1 max-w-4xl' :
        layout === 'featured' ? 'grid-cols-1 max-w-6xl mx-auto' : ''
      }`}>
        {posts.map((post, index) => (
          <article class={`bg-card rounded-xl overflow-hidden transition-all duration-200 flex flex-col hover:shadow-lg ${
            layout === 'list' ? 'flex-row items-center md:flex-col' :
            layout === 'featured' && index === 0 ? 'col-span-full flex-row items-center p-8 md:flex-col md:p-6' : ''
          }`}>
            {(post.data.ogImage || post.data.image) && (
              <div class={`relative overflow-hidden ${
                layout === 'grid' || (layout === 'featured' && index !== 0) ? 'aspect-video' :
                layout === 'list' || (layout === 'featured' && index === 0) ? 'w-80 h-48 flex-shrink-0 md:w-full md:h-48' :
                layout === 'modern' ? 'aspect-video' : ''
              }`}>
                <a href={getPostURL(post)}>
                  <Image 
                    src={images[imagePath + (post.data.ogImage || post.data.image)]()}
                    alt={post.data.title}
                    width={800}
                    height={600}
                    class="w-full h-full object-cover"
                  />
                </a>
                
                <!-- Image Overlay for Modern Layout -->
                {layout === 'modern' && (
                  <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-4 flex justify-between items-end">
                    <div class="flex flex-col gap-1">
                      <span class="text-white text-sm font-medium">{formatDate(post.data.date)}</span>
                      {showReadTime && post.data.readTime && (
                        <span class="text-white text-sm font-medium">{post.data.readTime}</span>
                      )}
                    </div>
                    <div class="flex items-center">
                      {showTags && post.data.tags && post.data.tags[0] && (
                        <span class="bg-primary text-primary-foreground px-3 py-1 rounded-full text-xs font-medium">{post.data.tags[0]}</span>
                      )}
                    </div>
                  </div>
                )}
              </div>
            )}
            
            <div class={`flex-1 flex flex-col gap-4 ${
              layout === 'featured' && index === 0 ? 'pl-8 md:pl-0' : 'p-6'
            }`}>
              {/* Regular meta for non-modern layouts */}
              {layout !== 'modern' && (
                <div class="flex items-center gap-4 text-sm text-muted-foreground flex-wrap">
                  {showTags && post.data.tags && (
                    post.data.tags.map((tag, index) => (
                      <span class="bg-primary/10 text-primary px-3 py-1 rounded-full font-medium text-xs">{tag}</span>
                    ))
                  )}
                  
                  <time class="text-sm" datetime={post.data.date}>
                    {formatDate(post.data.date)}
                  </time>
                  
                  {showReadTime && post.data.readTime && (
                    <span class="text-sm">{post.data.readTime}</span>
                  )}
                </div>
              )}
              
              <h3 class={`font-semibold leading-snug m-0 ${
                layout === 'featured' && index === 0 ? 'text-3xl md:text-2xl' : 'text-xl'
              }`}>
                <a href={getPostURL(post)} class="text-foreground no-underline transition-colors duration-200 hover:text-primary">{post.data.title}</a>
              </h3>
              
              {showExcerpts && post.data.excerpt && (
                <p class="text-muted-foreground leading-relaxed m-0 flex-1">{post.data.excerpt}</p>
              )}
              
              <div class={`flex justify-between items-center mt-auto text-sm ${
                layout === 'modern' ? 'flex-col items-start gap-2' : 'md:flex-col md:items-start md:gap-2'
              }`}>
                {showAuthors && post.data.author && (
                  <span class="text-muted-foreground">By {getAuthorName(post.data.author)}</span>
                )}
                
                <a href={getPostURL(post)} class={`flex items-center gap-2 text-primary no-underline font-medium transition-all duration-200 self-start hover:gap-3`}>
                  {layout === 'modern' ? 'Read Post' : 'Read more'}
                  <svg class="w-4 h-4 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    {layout === 'modern' ? (
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 17L17 7M17 7H7M17 7V17" />
                    ) : (
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    )}
                  </svg>
                </a>
              </div>
            </div>
          </article>
        ))}
      </div>
    )}
    
    <!-- Custom slot for additional content -->
    <div class="mt-16 flex justify-center">
      <slot />
    </div>
  </div>
</section>

